<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title></title>
<style id="style" type="text/css" rel="stylesheet"></style>
<script type="text/javascript">

var CONNECTION_ERROR = 'CONNECTION_ERROR';

var _body, _html, _doc, _win = window;
var $M = {}; // modules
var $A = {}; // public api

$A.NewXMLHttpRequest = _win.ActiveXObject ? function() { return new ActiveXObject('Microsoft.XMLHTTP') } : function() { return new _win.XMLHttpRequest() };
$A.AddEvent = _win.attachEvent ? function( elt, ev, handler ) { elt.attachEvent( 'on'+ev, handler ) } : function( elt, ev, handler ) { elt.addEventListener( ev, handler, false ) };
$A.RemoveEvent = _win.detachEvent ? function( elt, ev, handler ) { elt.detachEvent( 'on'+ev, handler ) } : function( elt, ev, handler ) { elt.removeEventListener( ev, handler, false ) };
$A.PreventDefault = function(ev) { ev.preventDefault ? ev.preventDefault() : (ev.returnValue = true) };
$A.StopPropagation = function(ev) { ev.stopPropagation ? ev.stopPropagation() : (ev.cancelBubble = false) };
$A.InsertHtmlBefore = function(elt, html) {

	var tmp = _doc.createElement('div');
	tmp.innerHTML = html;
	while ( tmp.firstChild )
		elt.parentNode.insertBefore( tmp.firstChild, elt );
}

$A.InsertHtmlInside = function(elt, html) {

	var tmp = _doc.createElement('div');
	tmp.innerHTML = html;
	while ( tmp.firstChild )
		elt.appendChild( tmp.firstChild );
}

$A.SetStyle = function(style) {

	var e = _doc.getElementById('style');
	if ( e.styleSheet ) { // IE
		e.styleSheet.cssText = style;
		_win.resizeBy(0,-1); _win.resizeBy(0,1); // force GUI refresh
	} else  {
		for( ;e.firstChild; e.removeChild(e.firstChild)); // cleanup
		e.appendChild(_doc.createTextNode(style)); // || firefox: e.innerHTML = style;
	}
}

$A.SetTitle = function(title) {

	_doc.title = title + ' - ';
}

$A.HttpRequest = function(OnResponse) {

	var _this = this;
	var xhr = $A.NewXMLHttpRequest();
	this.Ready = function() {

		return xhr.readyState == 0 || xhr.readyState == 4;
	}

	this.Abort = function() {

		if ( this.Ready() )
			return;
		if ( 'abort' in xhr )
			xhr.abort();
		else
			xhr.open( 'GET', 'about:blank', false );
	}

	this.Send = function(url, data, type, sync) {

		try {
			xhr.open( data == undefined ? 'GET' : 'POST', url, !sync );

			if ( !sync ) {
				xhr.onreadystatechange = function() {

					var status;
					try {
						if ( xhr.readyState != 4 )
							return;
						status = xhr.status;
						if ( status != 200 )
							throw 0;
						else
							OnResponse && OnResponse(_this, true, xhr.responseText, xhr.getResponseHeader('Content-Type'));
					} catch(ex) { OnResponse && OnResponse(_this, false, status ) }
				}
			}
			if (type != undefined)
				xhr.setRequestHeader('Content-Type', type);
			xhr.send(data == undefined ? null : data);
			if ( sync && xhr.status == 200 )
				return xhr.responseText;

		} catch(ex) { OnResponse && OnResponse(_this, false) }
	}
}

$A.AddModule = function(moduleConstructor) {

	var module = new moduleConstructor($A);
	$M[module.name] = module;
	module.OnAdd && module.OnAdd();
}

$A.RemoveModule = function(name) {

	$M[name].OnRemove && $M[name].OnRemove();
	delete $M[name];
}

$A.Dispatch = function(call /*, ...*/) {

	for ( var moduleName in $M )
		$M[moduleName][call] && $M[moduleName][call].apply($M[moduleName], arguments);
}

function CoreModule() {

	this.name = 'core';

	function EncodeArray(arr) {

		var str = '';
		for (var i=0; i < arr.length; i++)
			str += (i ? '&' : '') + (arr[i] ? encodeURIComponent(arr[i]) : '');
		return str;
	}

	function DecodeArray(str) {

		var arr = str.split('&');
		for (var i in arr)
			arr[i] = decodeURIComponent(arr[i]);
		return arr;
	}

	function DispatchResponse(data, type) {

		if ( type != 'application/x-www-form-urlencoded' )
			return;
		var tmp = DecodeArray(data);
		for ( var i in tmp )
			$A.Dispatch.apply(this, DecodeArray(tmp[i]));
	}

	var sendingQueue = [];
	var xhrPool = [ new $A.HttpRequest(OnResponse), new $A.HttpRequest(OnResponse) ];

	function OnResponse(xhr, status, data, type) {

		if ( status && data != '' ) {

			xhrPool.push(xhr);
			DispatchResponse(data, type);
			if ( sendingQueue.length || xhrPool.length == 2 )
				$A.Send();
		} else
			$A.Dispatch(CONNECTION_ERROR);
	}

	$A.Send = function(message) {

		message && sendingQueue.push(message);

		if ( xhrPool.length ) {

			var data;
			if (sendingQueue.length) {

				data = [];
				for ( var i in sendingQueue )
					data.push(EncodeArray(sendingQueue[i]));
				data = EncodeArray(data);
				sendingQueue.splice(0,sendingQueue.length);
			}
			xhrPool.shift().Send('?action=submit', data, 'application/x-www-form-urlencoded');
		}
	}

	$A.Send(); // pending request

	this.AddModule = function( _, moduleSrc ) {

		$A.AddModule(Function(moduleSrc));
	}
}

$A.AddEvent( window, 'load', function() {

	_doc = _win.document;
	_html = _doc.documentElement;
	_body = _doc.body;
	$A.AddModule(CoreModule);
});
</script>
</head><body></body>
</html>
