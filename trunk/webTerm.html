<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title></title>
<style id="style" type="text/css" rel="stylesheet"></style>
<script type="text/javascript">

var CONNECTION_ERROR = 'CONNECTION_ERROR';

var $M = {}; // modules
var $A = {}; // public api

$A.NewXMLHttpRequest = window.ActiveXObject ? function() { return new ActiveXObject('Microsoft.XMLHTTP') } : function() { return new XMLHttpRequest() };
$A.AddEvent = window.attachEvent ? function( elt, ev, handler ) { elt.attachEvent( 'on'+ev, handler ) } : function( elt, ev, handler ) { elt.addEventListener( ev, handler, false ) };
$A.RemoveEvent = window.detachEvent ? function( elt, ev, handler ) { elt.detachEvent( 'on'+ev, handler ) } : function( elt, ev, handler ) { elt.removeEventListener( ev, handler, false ) };
$A.PreventDefault = function(ev) { ev.preventDefault ? ev.preventDefault() : (ev.returnValue = true) };
$A.StopPropagation = function(ev) { ev.stopPropagation ? ev.stopPropagation() : (ev.cancelBubble = false) };
$A.InsertHtmlBefore = function(elt, html) {

	var tmp = _win.document.createElement('div');
	tmp.innerHTML = html;
	while ( tmp.firstChild )
		elt.parentNode.insertBefore( tmp.firstChild, elt );
}

$A.InsertHtmlInside = function(elt, html) {

	var tmp = _win.document.createElement('div');
	tmp.innerHTML = html;
	while ( tmp.firstChild )
		elt.appendChild( tmp.firstChild );
}

$A.SetStyle = function(style) {

	var e = _win.document.getElementById('style');
	if ( e.styleSheet ) { // IE
		e.styleSheet.cssText = style;
		_win.resizeBy(0,-1); _win.resizeBy(0,1); // force GUI refresh
	} else  {
		for( ;e.firstChild; e.removeChild(e.firstChild)); // cleanup
		e.appendChild(_win.document.createTextNode(style)); // || firefox: e.innerHTML = style;
	}
}

$A.SetTitle = function(title) {

	_win.document.title = title + ' - ';
}

$A.HttpRequest = function() {

	var _this = this;
	var xhr = new XMLHttpRequest();
	this.Ready = function() {

		return xhr.readyState == 0 || xhr.readyState == 4;
	}

	this.Abort = function() {

		if ( this.Ready() )
			return;
		if ( 'abort' in xhr )
			xhr.abort();
		else
			xhr.open( 'GET', 'about:blank', false );
	}

	this.Send = function(url, data, type, sync) {

		try {
			xhr.open( data == undefined ? 'GET' : 'POST', url, !sync );

			if ( !sync ) {
				xhr.onreadystatechange = function() {

					try {
						if ( xhr.readyState != 4 )
							return;
						if ( xhr.status != 200 )
							throw Error();
						else
							_this.OnResponse && _this.OnResponse(true, xhr.responseText, xhr.getResponseHeader('Content-Type'));
					} catch(ex) { _this.OnResponse && _this.OnResponse(false) }
				}
			}
			if (type != undefined)
				xhr.setRequestHeader('Content-Type', type);
			xhr.send(data == undefined ? null : data);
			if ( sync && xhr.status == 200 )
				return xhr.responseText;

		} catch(ex) { _this.OnResponse && _this.OnResponse(false) }
	}
}

$A.AddModule = function(moduleConstructor, id) {

	if ( !arguments.callee.moduleId )
		arguments.callee.moduleId = 1;
	id = id || arguments.callee.moduleId++;
	$M[id] = new moduleConstructor($A);
	return $M[id].id = id;
}

$A.RemoveModule = function(id) {

	delete $M[id];
}

$A.Dispatch = function(name) {

	for ( var moduleName in $M )
		$M[moduleName][name] && $M[moduleName][name].apply(this, arguments);
}

function CoreModule($A) {

	function ObjectToSource(o) {

		var source = '';
		if ( o instanceof Array ) {

			for ( var i = 0; i < o.length; i++) {
				var val = arguments.callee(o[i]);
				source += (i?',':'')+(val==undefined?'':val);
			}
			return '['+source+']';
		}
		if ( typeof(o) == 'string' )
			return '"'+o.replace(/["\\]/g, function(c) { return '\\'+c } )+'"'; //'
		if ( o instanceof Object ) {

			for ( var p in o )
				source += (source?',':'')+'"'+p+'":'+arguments.callee(o[p]);
			return '{'+source+'}';
		}
		return o;
	}

	function SourceToObject(s) {

		try {
			return eval('('+s+')');
		} catch(ex) {}
	}

	function DispatchResponse(data, type) {

		var obj = SourceToObject(data);
		if ( type != 'text/json' && !(obj instanceof Array) )
			return;

		for ( var i in obj )
			$A.Dispatch.apply(this, obj[i]);
	}


	var sendingQueue = [];

	var outputHttpRequest = new $A.HttpRequest();

	outputHttpRequest.OnResponse = function(status, data, type) {

		if ( status ) {

			DispatchResponse(data);
			$A.Send();
		} else
			$A.Dispatch(CONNECTION_ERROR);
	}

	$A.Send = function(/*...*/) {

		if ( arguments.length ) {

			var item = [];
			for ( var i=0; i<arguments.length; i++ )
				item.push(arguments[i]);
			sendingQueue.push(item);
		}

		if ( !outputHttpRequest.Ready() )
			return;

		if ( sendingQueue.length ) {

			outputHttpRequest.Send('?action=submit', ObjectToSource(sendingQueue), 'text/json');
			sendingQueue.splice(0);
		}
	}

	var inputHttpRequest = new $A.HttpRequest();

	function StartPendingRequest() {

		inputHttpRequest.Send('?action=wait', null);
	}

	inputHttpRequest.OnResponse = function(status, data, type) {

		if ( status ) {

			DispatchResponse(data);
			StartPendingRequest();
		} else
			$A.Dispatch(CONNECTION_ERROR);
	}

	StartPendingRequest();

	this.AddModule = function( tmp, moduleName, module ) {

		$A.AddModule(module, moduleName);
	}
}


var _body, _html, _win;

$A.AddEvent( window, 'load', function() {

	_win = window;
	_body = _win.document.body;
	_html = _win.document.documentElement;
	$A.AddModule(CoreModule);
});
</script>
</head><body></body>
</html>
