<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>console</title>
<style type="text/css">
html, body {
	padding: 0px;
	margin: 0px;
	height: 100%;
	background-color: black;
	overflow: hidden;
}
#in, #out {
	border-style: none;
	background-color: transparent;
	color: #BBB;
	font-family: console, monospace;
	font-weight: bold;
	font-size: 10pt;
}
#in {
	display: block;
	position: absolute;
	bottom: 0px;
	width: 100%;
	border-top: 2px solid #666;
	padding-left: 2px;
}
#out {
	overflow: auto;
}
</style>
<script type="text/javascript">

if (window.ActiveXObject) {
    var xhr = new ActiveXObject("Microsoft.XMLHTTP");
	var pxhr = new ActiveXObject("Microsoft.XMLHTTP");
} else {
	var xhr = new XMLHttpRequest;
	var pxhr = new XMLHttpRequest;
}

var _in, _out;
var unloadMessage = 'This will close the current session.';

function recalcLayout() {

	_out.style.height = document.documentElement.clientHeight - _in.offsetHeight - 1 + 'px';
	_out.scrollTop = _out.scrollHeight;
}

function Cout(msg) {

	var isAtEnd = (_out.scrollTop + _out.offsetHeight >= _out.scrollHeight );
	_out.innerHTML += msg;
	if ( isAtEnd )
		_out.scrollTop = _out.scrollHeight;
}

function Error(msg, color) {

	return '<span style="color:'+(color||'red')+'">'+msg+'</span>';
}

function Disconnect() {

	Cout(Error('Connection closed<br/>'));
	unloadMessage = undefined;
	xhr.abort();
	pxhr.abort();
}

function ProcessResponse(data, type) {

	if ( data )
		switch (type) {
			case 'application/javascript':
			case 'application/x-javascript':
				eval(data);
				break
			case 'text/html':
			case 'text/plain':
				Cout(data);
				break
			default:
				Cout(Error(type,'yellow')+'<br/>');
		}
}

function Request(x, url, data, OnResponse) {

	try {
		x.open( data==null ? 'GET' : 'POST', url, true );
		x.onreadystatechange = function() {

			try {
				if ( x.readyState != 4 )
					return;
				if ( x.status != 200 )
					OnResponse(false);
				else
					OnResponse(true, x.responseText, x.getResponseHeader('Content-Type'));
			} catch(ex) { OnResponse(false) }
		}
		x.send(data);
	} catch(ex) { OnResponse(false) }
}

function Send(data) {

	Request(xhr, '?action=submit', data, function(status, data, type) {

		if ( status )
			ProcessResponse(data, type);
		else
			Disconnect();
	});
}

function StartPendingRequest() {

	Request(pxhr, '?action=wait', null, function(status, data, type) {

		if ( status ) {
			ProcessResponse(data, type);
			StartPendingRequest();
		} else
			Disconnect();
	});
}

function Init() {

	_in = document.getElementById('in');
	_out = document.getElementById('out');
	StartPendingRequest();
	recalcLayout();
	_in.focus();
}

var stack = [''], stackp = 0;
function OnKey(event) {

	switch (event.keyCode) {

		case 38: // up
			if ( event.shiftKey || event.ctrlKey || event.altKey )
				return;
			if ( stackp == 0 )
				stack[0] = _in.value;
			if ( stackp < stack.length-1 )
				stackp++;
			_in.value = stack[stackp];
			break;
		case 40: // down
			if ( event.shiftKey || event.ctrlKey || event.altKey )
				return;
			_in.value = stackp ? stack[--stackp] : stack[0];
			break;
		case 13:
			if ( event.shiftKey || event.ctrlKey || event.altKey )
				return;
			stackp=0;
			stack[0] = _in.value;
			if ( stack[0] == stack[1] )
				stack[0] = '';
			else
				stack.unshift('');
			Send(_in.value);
			_in.value = '';
			_in.focus();
			break;
		case 27:
			_in.value = stackp ? stack[stackp=0] : '';
			break;
		case 33: // pageup
			if ( event.ctrlKey )
				_out.scrollTop -= _out.clientHeight;
			else
				return;
			break;
		case 34: // pagedown
			if ( event.ctrlKey )
				_out.scrollTop += _out.clientHeight;
			else
				return;
			break;
		case 35: // end
			if ( event.ctrlKey )
				_out.scrollTop = _out.scrollHeight;
			else
				return;
			break;
		case 36: // home
			if ( event.ctrlKey )
				_out.scrollTop = 0;
			else
				return;
			break;
		default:
			return;
	}
	event.preventDefault ? event.preventDefault() : event.cancelBubble = true;
	event.stopPropagation ? event.stopPropagation() : event.returnValue = false;
}
</script>
</head>
<body onload="Init()" onbeforeunload="return unloadMessage" onresize="recalcLayout()">
<div id="out" onclick="_in.focus()"></div>
<input type="text" id="in" onkeydown="OnKey(event)" autocomplete="off" />
</body>
</html>
